{% extends 'publicBase.html' %}
{% block title %}Verify Email - Todo App{% endblock %}
{% block content %}

<div class="min-h-screen bg-gray-950 flex items-center justify-center px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 max-w-6xl w-full">
        <div class="flex flex-col justify-center space-y-8">
            <div>
                <h1 class="text-5xl font-bold text-white mb-3">Verify Email</h1>
                <p class="text-gray-400 text-lg">We've sent a 6-digit OTP to <span class="text-purple-400">{{ email }}</span></p>
            </div>

            <div class="space-y-6 max-w-sm">
                {% if messages %}
                    {% for message in messages %}
                        <div class="p-4 rounded-lg {% if message.tags %}bg-red-900 border border-red-700 text-red-200{% else %}bg-green-900 border border-green-700 text-green-200{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="post" class="space-y-6">
                    {% csrf_token %}

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-4">Enter 6-Digit OTP</label>
                        <div class="flex gap-3 justify-center mb-4">
                            <input type="text" id="otp1" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp2" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp3" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp4" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp5" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp6" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                        </div>
                        <input type="hidden" id="otp" name="otp">
                    </div>

                    <button type="submit" class="w-full gradient-bg text-white font-semibold py-3 rounded-lg hover:opacity-90 transition duration-200 mt-8">
                        Verify OTP
                    </button>
                </form>

                <div class="text-center text-gray-400 text-sm">
                    Didn't receive OTP? 
                    <button type="button" id="resendBtn" onclick="resendOTP()" class="text-purple-400 hover:text-purple-300 font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2">
                        <span id="resendText">Resend</span>
                        <svg id="resendLoader" class="hidden animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

                <div class="text-center text-gray-400 text-sm">
                    <a href="{% url 'register' %}" class="text-purple-400 hover:text-purple-300 font-semibold transition">Back to Register</a>
                </div>
            </div>
        </div>

        <div class="hidden lg:flex items-center justify-center">
            <div class="relative w-full h-96">
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="relative w-48 h-48">
                        <div class="absolute inset-0 bg-gradient-to-br from-purple-500/20 to-transparent rounded-lg transform -rotate-6 blur-2xl"></div>
                        <div class="relative w-full h-full border-2 border-purple-500/30 rounded-lg bg-gradient-to-br from-purple-900/20 to-transparent backdrop-blur-sm transform perspective">
                            <div class="absolute inset-2 border border-purple-400/20 rounded-lg"></div>
                            <div class="absolute top-4 right-4 w-3 h-3 rounded-full bg-purple-400/60"></div>
                            <div class="absolute bottom-6 left-4 w-2 h-2 rounded-full bg-purple-300/40"></div>
                            <div class="absolute top-1/2 right-6 w-2 h-2 rounded-full bg-purple-400/50"></div>
                        </div>
                        <div class="absolute inset-0 border border-purple-500/20 rounded-full transform scale-150 animate-pulse"></div>
                    </div>
                </div>

                <div class="absolute inset-0 flex flex-col items-center justify-end text-center pb-8">
                    <p class="text-3xl font-bold text-gray-300 mb-2">Secure Verification</p>
                    <p class="text-gray-500 text-lg">Your email is protected</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showNotification(message, type = 'success') {
            let container = document.getElementById('notificationContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notificationContainer';
                container.className = 'fixed top-4 right-4 z-50 space-y-2';
                document.body.appendChild(container);
            }
            
            const notification = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' 
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                : type === 'error'
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            
            notification.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 transform translate-x-full transition-transform duration-300 min-w-[320px]`;
            notification.innerHTML = `
                <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${icon}
                </svg>
                <span class="flex-1 font-medium">${message}</span>
                <button class="text-white hover:text-gray-200 transition" onclick="this.parentElement.remove()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 10);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        const inputs = document.querySelectorAll('input[id^="otp"]');

        inputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                handleInput(e, index);
            });

            input.addEventListener('keydown', (e) => {
                handleKeydown(e, index);
            });

            input.addEventListener('paste', (e) => {
                handlePaste(e, index);
            });
        });

        function handleInput(e, index) {
            const input = e.target;
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            
            updateOTPValue();
        }

        function handleKeydown(e, index) {
            if (e.key === 'Backspace' && index > 0 && inputs[index].value === '') {
                inputs[index - 1].focus();
                inputs[index - 1].value = '';
                updateOTPValue();
            }            
            if (e.key === 'Delete') {
                inputs[index].value = '';
                updateOTPValue();
                e.preventDefault();
            }
        }

        function handlePaste(e, index) {
            e.preventDefault();            
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const digits = pastedText.replace(/[^0-9]/g, '').split('');
            
            let currentIndex = index;
            digits.forEach((digit) => {
                if (currentIndex < inputs.length) {
                    inputs[currentIndex].value = digit;
                    currentIndex++;
                }
            });
            
            if (currentIndex < inputs.length) {
                inputs[currentIndex].focus();
            } else {
                inputs[inputs.length - 1].focus();
            }
            
            updateOTPValue();
        }

        function updateOTPValue() {
            const otp = 
                document.getElementById('otp1').value +
                document.getElementById('otp2').value +
                document.getElementById('otp3').value +
                document.getElementById('otp4').value +
                document.getElementById('otp5').value +
                document.getElementById('otp6').value;
            
            document.getElementById('otp').value = otp;
        }

        function resendOTP() {
            const email = '{{ email }}';
            const resendBtn = document.getElementById('resendBtn');
            const resendText = document.getElementById('resendText');
            const resendLoader = document.getElementById('resendLoader');
            
            resendBtn.disabled = true;
            resendText.textContent = 'Sending...';
            resendLoader.classList.remove('hidden');
            
            fetch('{% url "resend_otp" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                resendBtn.disabled = false;
                resendText.textContent = 'Resend';
                resendLoader.classList.add('hidden');
                
                if (data.success) {
                    showNotification('OTP sent successfully to ' + email, 'success');
                    inputs.forEach(input => input.value = '');
                    inputs[0].focus();
                } else {
                    showNotification('Failed to send OTP: ' + data.message, 'error');
                }
            })
            .catch(error => {
                resendBtn.disabled = false;
                resendText.textContent = 'Resend';
                resendLoader.classList.add('hidden');
                
                console.error('Error:', error);
                showNotification('An error occurred. Please try again.', 'error');
            });
        }
    </script>
</div>
{% endblock %}
