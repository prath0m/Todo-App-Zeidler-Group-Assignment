{% extends 'publicBase.html' %}

{% block title %}Verify Email - Todo App{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-950 flex items-center justify-center px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 max-w-6xl w-full">
        <!-- Left Section -->
        <div class="flex flex-col justify-center space-y-8">
            <!-- Header -->
            <div>
                <h1 class="text-5xl font-bold text-white mb-3">Verify Email</h1>
                <p class="text-gray-400 text-lg">We've sent a 6-digit OTP to <span class="text-purple-400">{{ email }}</span></p>
            </div>

            <!-- Verification Form -->
            <div class="space-y-6 max-w-sm">
                {% if messages %}
                    {% for message in messages %}
                        <div class="p-4 rounded-lg {% if message.tags %}bg-red-900 border border-red-700 text-red-200{% else %}bg-green-900 border border-green-700 text-green-200{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <!-- OTP Form -->
                <form method="post" class="space-y-6">
                    {% csrf_token %}

                    <!-- OTP Input Fields -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-4">Enter 6-Digit OTP</label>
                        <div class="flex gap-3 justify-center mb-4">
                            <input type="text" id="otp1" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp2" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp3" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp4" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp5" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                            <input type="text" id="otp6" maxlength="1" class="w-12 h-12 text-center bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" inputmode="numeric">
                        </div>
                        <input type="hidden" id="otp" name="otp">
                    </div>

                    <!-- Verify Button -->
                    <button type="submit" class="w-full gradient-bg text-white font-semibold py-3 rounded-lg hover:opacity-90 transition duration-200 mt-8">
                        Verify OTP
                    </button>
                </form>

                <!-- Resend OTP -->
                <div class="text-center text-gray-400 text-sm">
                    Didn't receive OTP? 
                    <button type="button" onclick="resendOTP()" class="text-purple-400 hover:text-purple-300 font-semibold transition">
                        Resend
                    </button>
                </div>

                <!-- Back to Register -->
                <div class="text-center text-gray-400 text-sm">
                    <a href="{% url 'register' %}" class="text-purple-400 hover:text-purple-300 font-semibold transition">Back to Register</a>
                </div>
            </div>
        </div>

        <!-- Right Section - Hero Visual -->
        <div class="hidden lg:flex items-center justify-center">
            <div class="relative w-full h-96">
                <!-- Floating 3D Box -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="relative w-48 h-48">
                        <!-- 3D Box shadow effect -->
                        <div class="absolute inset-0 bg-gradient-to-br from-purple-500/20 to-transparent rounded-lg transform -rotate-6 blur-2xl"></div>
                        
                        <!-- Main box -->
                        <div class="relative w-full h-full border-2 border-purple-500/30 rounded-lg bg-gradient-to-br from-purple-900/20 to-transparent backdrop-blur-sm transform perspective">
                            <!-- Inner glow -->
                            <div class="absolute inset-2 border border-purple-400/20 rounded-lg"></div>
                            
                            <!-- Floating elements -->
                            <div class="absolute top-4 right-4 w-3 h-3 rounded-full bg-purple-400/60"></div>
                            <div class="absolute bottom-6 left-4 w-2 h-2 rounded-full bg-purple-300/40"></div>
                            <div class="absolute top-1/2 right-6 w-2 h-2 rounded-full bg-purple-400/50"></div>
                        </div>

                        <!-- Orbital ring -->
                        <div class="absolute inset-0 border border-purple-500/20 rounded-full transform scale-150 animate-pulse"></div>
                    </div>
                </div>

                <!-- Text overlay -->
                <div class="absolute inset-0 flex flex-col items-center justify-end text-center pb-8">
                    <p class="text-3xl font-bold text-gray-300 mb-2">Secure Verification</p>
                    <p class="text-gray-500 text-lg">Your email is protected</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const inputs = document.querySelectorAll('input[id^="otp"]');

        // Handle input on each field
        inputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                handleInput(e, index);
            });

            input.addEventListener('keydown', (e) => {
                handleKeydown(e, index);
            });

            input.addEventListener('paste', (e) => {
                handlePaste(e, index);
            });
        });

        function handleInput(e, index) {
            const input = e.target;
            
            // Only allow digits
            input.value = input.value.replace(/[^0-9]/g, '');
            
            // If user types a digit, move to next field
            if (input.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            
            updateOTPValue();
        }

        function handleKeydown(e, index) {
            // Handle backspace - move to previous field
            if (e.key === 'Backspace' && index > 0 && inputs[index].value === '') {
                inputs[index - 1].focus();
                inputs[index - 1].value = '';
                updateOTPValue();
            }
            
            // Handle delete key
            if (e.key === 'Delete') {
                inputs[index].value = '';
                updateOTPValue();
                e.preventDefault();
            }
        }

        function handlePaste(e, index) {
            e.preventDefault();
            
            // Get pasted text
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const digits = pastedText.replace(/[^0-9]/g, '').split('');
            
            // Distribute pasted digits across fields starting from current index
            let currentIndex = index;
            digits.forEach((digit) => {
                if (currentIndex < inputs.length) {
                    inputs[currentIndex].value = digit;
                    currentIndex++;
                }
            });
            
            // Focus the next empty field or last field
            if (currentIndex < inputs.length) {
                inputs[currentIndex].focus();
            } else {
                inputs[inputs.length - 1].focus();
            }
            
            updateOTPValue();
        }

        function updateOTPValue() {
            const otp = 
                document.getElementById('otp1').value +
                document.getElementById('otp2').value +
                document.getElementById('otp3').value +
                document.getElementById('otp4').value +
                document.getElementById('otp5').value +
                document.getElementById('otp6').value;
            
            document.getElementById('otp').value = otp;
        }

        function resendOTP() {
            const email = '{{ email }}';
            
            fetch('{% url "resend_otp" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('OTP sent successfully to ' + email);
                    // Clear OTP fields
                    inputs.forEach(input => input.value = '');
                    inputs[0].focus();
                } else {
                    alert('Failed to send OTP: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    </script>
</div>
{% endblock %}
